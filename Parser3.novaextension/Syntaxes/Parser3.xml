<?xml version="1.0" encoding="UTF-8"?>
<syntax name="parser3">
    <meta>
        <name>Parser3</name>
        <type>script</type>
        <preferred-file-extension>html</preferred-file-extension>
    </meta>
    
    <detectors>
        <extension priority="1.0">html,p,pt</extension>
        <extension priority="0.9">h</extension>
    </detectors>

	<identifiers>
		<prefixes>
			<string>$</string>
			<string>^</string>
			<string>@</string>
		</prefixes>
	</identifiers>

	<indentation>
		<increase>
			<expression>(\{[^}\"']*$)|(\[[^\]\"']*$)|(\([^)\"']*$)</expression>
		</increase>
		<decrease>
			<expression>^\s*(\s*/\*.*\*/\s*)*[\}\]\)\\]</expression>
		</decrease>
	</indentation>
    

    <comments>
		<single>
			<expression>#</expression>
		</single>
		<multiline>
			<starts-with>
				<expression>^rem{</expression>
			</starts-with>
			<ends-with>
				<expression>}</expression>
			</ends-with>
		</multiline>
    </comments>

	<brackets>
		<pair open="{" close="}" />
		<pair open="[" close="]" />
		<pair open="(" close=")" />
	</brackets>

    <surrounding-pairs>
        <pair open="{" close="}" />
        <pair open="[" close="]" />
        <pair open="(" close=")" />
        <pair open="&apos;" close="&apos;" />
		<pair open="&quot;" close="&quot;" />
		<pair open="`" close="`" />
    </surrounding-pairs>

	<scopes>
		<include syntax="self" collection="comments" />
		<include syntax="self" collection="definitions" />
		<include syntax="self" collection="keywords" />
		<include syntax="self" collection="values" />
		<include syntax="self" collection="identifiers" />
		<include syntax="self" collection="blocks" />
		<include syntax="self" collection="syntax" />
		<include syntax="self" collection="properties" />
	</scopes>

    <collections>

		<!-- Comments -->
		<collection name="comments">
			<scope name="parser3.comment.single" spell-check="true">
				<expression>^\#(.*)$</expression>
				<capture number="1" name="parser3.comment.text" />
			</scope>
			<scope name="parser3.comment.block" spell-check="true">
				<starts-with>
					<expression>\^rem\{</expression>
				</starts-with>
				<ends-with>
					<expression>\}</expression>
				</ends-with>
			</scope>
		</collection>

		<!-- Variables -->
		<collection name="variables">
		
			<scope name="parser3.identifier.variable.core">
				<!-- <strings word-boundary="false" suffix="\b"> -->
				<strings word-boundary="false">
					<string>MAIN</string>
					<string>LIMITS</string>
					<string>MAIL</string>
					<string>SQL</string>
					<string>MIME-TYPES</string>           
				</strings>
			</scope>
			
			<scope name="parser3.identifier.variable">
				<symbol type="variable" scope="local" />
				<expression>(\$[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*)</expression>
				<capture number="1" name="parser3.identifier.name" />
			</scope>
		</collection>
		
	<!-- Definitions -->
		<collection name="definitions">
			
			<scope name="parser3.definition.function">
				<symbol type="function" />
				<expression>^@([a-zA-Z_][a-zA-Z0-9_]*)\[[a-zA-Z0-9_;]*\]</expression>
				<!-- <capture number="1" name="parser3.keyword" /> -->
				<capture number="1" name="parser3.identifier.function.name" />
			</scope>
			
			<scope name="parser3.definition.function.core">
				<symbol type="function" />
				<expression>^@([a-zA-Z_][a-zA-Z0-9_]*)</expression>
				<!-- <capture number="1" name="parser3.keyword" /> -->
				<capture number="1" name="parser3.identifier.function.name" />
			</scope>
			
			<!-- Constant -->
			<!-- <scope name="parser3.definition.constant">
				<symbol type="constant" scope="local" />
				<expression>(?&lt;!\.)([A-Z][A-Z0-9_]*)\s*(\=)(?!\=)</expression>
				<capture number="1" name="parser3.identifier.constant.name" />
				<capture number="2" name="parser3.operator" />
			</scope> -->
			
		</collection>
		
		<!-- Keywords -->
		<collection name="keywords">
			
			<!-- <scope name="parser3.keyword.symbol">
				<strings>
					<string>^</string>
				</strings>
			</scope> -->
			
			<scope name="parser3.keyword">
				<strings>
					<string>def</string>
					<string>eq</string>
					<string>ne</string>
					<string>is</string>
					<string>in</string>
					<string>lt</string>
					<string>qt</string>
					<string>le</string>
					<string>ge</string>
					<string>-d</string>
					<string>-f</string>
				</strings>
			</scope>
			
			<!-- [foo] -->			
			<scope name="parser3.keyword.property">
				<strings prefix="(\[)" suffix="(?=\])">
					<string>as-is</string>
					<string>file-spec</string>
					<string>uri</string>
					<string>http-header</string>
					<string>mail-header</string>
					<string>sql</string>
					<string>js</string>
					<string>json</string>
					<string>parser-code</string>
					<string>regex</string>
					<string>xml</string>
					<string>html</string>
					<string>optimized-as-is</string>
					<string>optimized-xml</string>
					<string>optimized-html</string>
					<!-- date -->
					<string>datetime</string>
					<string>date</string>
					<string>time</string>
					<string>year</string>
					<string>month</string>
					<string>day</string>
					<string>TZ</string>
					<string>rus</string>
					<string>eng</string>
				</strings>
			</scope>
			
			<!-- [foo] -->			
			<scope name="parser3.keyword.property.attributes">
				<strings prefix="(?&lt;=\[|;)" suffix="(?=;|\])">
					<!-- file -->
					<string>text</string>
					<string>binary</string>
					<string>UTF-8</string>
					<string>first</string>
					<string>last</string>
					<string>key</string>
					<string>value</string>
					<string>hash</string>
					<string>desc</string>
					<string>asc</string>
				</strings>
			</scope>
			
			<!-- [foo] -->			
			<scope name="parser3.keyword.error.types">
				<strings>
					<string>parser.compile</string>
					<string>parser.runtime</string>
					<string>parser.interrupted</string>
					<string>number.zerodivision </string>
					<string>number.format</string>
					<string>file.missing</string>
					<string>file.access</string>
					<string>file.read</string>
					<string>file.execute</string>
					<string>date.range</string>
					<string>pcre.execute</string>
					<string>image.format</string>
					<string>sql.connect</string>
					<string>sql.execute</string>
					<string>xml</string>
					<string>smtp.connect</string>
					<string>smtp.execute</string>
					<string>email.format</string>
					<string>email.send</string>
					<string>http.host</string>
					<string>http.connect</string>
					<string>http.response</string>
					<string>http.status</string>
					<string>http.timeout</string>
					<string>curl.host</string>
					<string>curl.connect</string>
					<string>curl.status</string>
					<string>curl.ssl</string>
					<string>curl.timeout</string>
					<string>curl.fail</string>
				</strings>
			</scope>

			<!-- ^foo({[ -->
			<scope name="parser3.keyword.operator">
				<strings prefix="(?&lt;=\^)" suffix="(?=\(|\{|\[)">
					<string>break</string>
					<string>cache</string>
					<string>connect</string>
					<string>continue</string>
					<string>eval</string>
					<string>if</string>
					<string>for</string>
					<string>foreach</string>
					<string>process</string>
					<string>return</string>
					<string>sleep</string>
					<string>switch</string>
					<string>throw</string>
					<string>while</string>
					<string>use</string>
				</strings>
			</scope>
			
			<!-- @foo -->
			<scope name="parser3.keyword.core.method">
				<!-- <strings prefix="^(?&lt;=\@)"> -->
				<strings prefix="^\@">
					<string>auto</string>
					<string>BASE</string>
					<string>CLASS</string>
					<string>create</string>
					<string>main</string>
					<string>postprocess</string>
					<string>OPTIONS</string>
					<string>static</string>
					<string>unhandled_exception</string>
					<string>USE</string>
				</strings>
			</scope>
			
			<!-- ^foo. -->			
			<!-- <scope name="parser3.keyword.operator.method">
				<strings prefix="(?&lt;=\^)" suffix="(?=\.)">
					<string></string>
				</strings>
			</scope> -->
			
			<!-- $foo -->			
			<scope name="parser3.keyword.operator.variables">
				<strings prefix="(?&lt;=\$)">
					<string>return</string>
				</strings>
			</scope>
			
			<!-- $foo -->
			<scope name="parser3.keyword.core.variables">
				<strings prefix="(?&lt;=\$)">
					<string>MAIN</string>
					<string>LIMITS</string>
					<string>MAIL</string>
					<string>SQL</string>
					<string>MIME-TYPES</string>
				</strings>
			</scope>
			
			<!-- ^foo -->			
			<scope name="parser3.keyword.core.variable.method">
				<strings prefix="(?&lt;=\^)" suffix="(?=\.)">
					<string>MAIN</string>
					<string>LIMITS</string>
					<string>MAIL</string>
					<string>SQL</string>
					<string>MIME-TYPES</string>
				</strings>
			</scope>

			<!-- ^foo: -->
			<scope name="parser3.keyword.class">
				<strings prefix="(?&lt;=\^)" suffix="(?=[:\.])">
					<string>cookie</string>
					<string>curl</string>
					<string>date</string>
					<string>double</string>
					<string>int</string>
					<string>env</string>
					<string>file</string>
					<string>form</string>
					<string>hash</string>
					<string>hashfile</string>
					<string>math</string>
					<string>string</string>
					<string>table</string>
					<string>void</string>
				</strings>
			</scope>
			
			<!-- $foo: -->
			<scope name="parser3.keyword.class.static">
				<strings prefix="(?&lt;=\$)" suffix="(?=:)">
					<string>console</string>
					<string>cookie</string>
					<string>env</string>
					<string>form</string>
				</strings>
			</scope>

			<!-- :foo({[ -->
			<scope name="parser3.keyword.class.method">
				<strings prefix="(?&lt;=:)" suffix="(?=\(|\{|\[)">
					<string>base64</string>
					<string>calendar</string>
					<!-- <string>create</string> -->
					<string>cos</string>
					<string>idna</string>
					<string>js-unescape</string>
					<string>load</string>
					<string>last-day</string>
					<string>roll</string>
					<string>sin</string>
					<string>sql</string>
					<string>unescape</string>
					<!-- file -->
					<string>base64</string>
					<string>basename</string>
					<string>copy</string>
					<string>crc32</string>
					<string>delete</string>
					<string>dirname</string>
					<string>find</string>
					<string>fullpath</string>
					<string>justext</string>
					<string>justname</string>
					<string>list</string>
					<string>lock</string>
					<string>md5</string>
					<string>move</string>
				</strings>
			</scope>
			
			<!-- ::foo({[ -->
			<scope name="parser3.keyword.class.method">
				<strings prefix="(?&lt;=(::))" suffix="(?=\(|\{|\[)">
					<string>create</string>
					<string>now</string>
					<string>today</string>
					<string>unix-timestamp</string>
					<!-- file -->					
					<string>base64</string>
					<string>cgi</string>
					<string>exec</string>
					<string>sql</string>
					<string>stat</string>
				</strings>
			</scope>

			<!-- :foo -->
			<scope name="parser3.keyword.class.property">
				<strings prefix="(?&lt;=:)">
					<string>fields</string>
					<string>files</string>
					<string>imap</string>
					<string>line</string>
					<string>qtail</string>
					<string>tables</string>
					<!-- env -->
					<string>PARSER_VERSION</string>
					<string>REMOTE_ADDR</string>
					<string>HTTP_USER_AGENT</string>
				</strings>
			</scope>

			<!-- .foo({[ -->
			<scope name="parser3.keyword.class.instance.method">
				<strings prefix="(?&lt;=\.)" suffix="(?=\(|\{|\[)">
					<string>save</string>
					<!-- date -->
					<string>gmt-string</string>
					<string>iso-string</string>
					<string>last-day</string>
					<string>roll</string>
					<string>sql-string</string>
					<string>unix-timestamp</string>
					<!-- double -->
					<!-- int -->					
					<string>format</string>
					<string>inc</string>
					<string>dec</string>
					<string>mul</string>
					<string>div</string>
					<string>mod</string>
					<string>int</string>
					<string>double</string>
					<string>bool</string>
					<!-- file -->
					<string>base64</string>
					<string>crc32</string>
					<string>md5</string>
					<string>save</string>
					<string>sql-string</string>
					<!-- string -->				
					<string>base64</string>
					<string>bool</string>
					<string>int</string>
					<string>idna</string>
					<string>double</string>
					<string>js-escape</string>
					<string>format</string>
					<string>left</string>
					<string>length</string>
					<string>lower</string>
					<string>match</string>
					<string>mid</string>
					<string>pos</string>
					<string>replace</string>
					<string>right</string>
					<string>split</string>
					<string>trim</string>
					<string>upper</string>
					<!-- table -->
					<string>append</string>
					<string>columns</string>
					<string>count</string>
					<string>csv-string</string>
					<string>flip</string>
					<string>hash</string>
					<string>insert</string>
					<string>join</string>
					<string>menu</string>
					<string>line</string>
					<string>foreach</string>
					<string>offset</string>
					<string>select</string>
					<string>sort</string>
				</strings>
			</scope>
			
			<!-- .foo -->
			<scope name="parser3.keyword.class.instance.value">
				<strings prefix="(?&lt;=\.)">
					<!-- date -->
					<string>month</string>
					<string>year</string>
					<string>day</string>
					<string>hour</string>
					<string>minute</string>
					<string>second</string>
					<string>weekday</string>
					<string>week</string>
					<string>weekyear</string>
					<string>yearday</string>
					<string>daylightsaving</string>
					<string>TZ</string>
					<!-- file -->
					<string>name</string>
					<string>size</string>
					<string>size</string>
					<string>text</string>
					<string>cdate</string>
					<string>mdate</string>
					<string>adate</string>
					<string>stderr</string>
					<string>status</string>
					<string>mode</string>
					<string>content-type</string>
					<string>SERVER</string>
				</strings>
			</scope>
			
		</collection>

		<!-- Values -->
		<collection name="values">
			<include syntax="self" collection="strings" />
			<scope name="parser3.value.number">
				<expression>\b(\-|\+)?(?:\d+(?:\.\d*)?|(?:\.\d+))(l|L|j|J)?\b</expression>
			</scope>
			<scope name="parser3.value.boolean">
				<strings>
					<string>true</string>
					<string>false</string>
				</strings>
			</scope>
		</collection>

		<!-- Strings -->
		<collection name="strings">
			<scope name="parser3.string.double-quoted">
				<expression>&quot;((?:[^&quot;\\]|\\.)*)(?:&quot;|$)</expression>
				<capture number="1" name="parser3.string.double-quoted.text" />
			</scope>
			<scope name="parser3.string.single-quoted">
				<expression>&apos;((?:[^&apos;\\]|\\.)*)(?:&apos;|$)</expression>
				<capture number="1" name="parser3.string.single-quoted.text" />
			</scope>
			<scope name="parser3.string.single-quoted">
				<expression>q([^\\q])((?:[^\1\\]|\\.)*)(?:\1|$)</expression>
				<capture number="1" name="parser3.string.single-quoted.text" />
			</scope>
			<!-- <scope name="parser3.string.regex">
				<expression>/([^/\\]|\\.)*(?:/|$)</expression>
				<capture number="1" name="parser3.string.regex.text" />
			</scope> -->
		</collection>
		
		
		<!-- <collection name="properties">
			<scope name="parser3.property">
				<symbol type="property" />
				<starts-with>
					<expression>\[</expression>
					<capture number="0" name="parser3.property.bracket" />
				</starts-with>
				<ends-with>
					<expression>\]</expression>
					<capture number="0" name="parser3.property.bracket" />
				</ends-with>
				<subscopes>
					<include syntax="self" />
				</subscopes>
			</scope>
		</collection> -->
		
		<!-- Identifiers -->
		<!-- <collection name="identifiers"> -->
		<!--
			<scope name="parser3.identifier.variable.hash">
				<expression>\b%([a-zA-Z_][a-zA-Z0-9_]*)\b</expression>
			</scope>
			<scope name="parser3.identifier.variable.array">
				<expression>\b@([a-zA-Z_][a-zA-Z0-9_]*)\b</expression>
			</scope>
			<scope name="parser3.identifier.variable.scalar">
				<expression>\b\$([a-zA-Z_][a-zA-Z0-9_]*)\b</expression>
			</scope>
			<scope name="parser3.identifier.property">
				<expression>\b(?&lt;=\.)([a-zA-Z_][a-zA-Z0-9_]*)(?!\()\b</expression>
			</scope>
		-->
			<!-- <scope name="parser3.identifier.method"> -->
				<!-- <expression>\b(?&lt;=\.)([a-zA-Z_][a-zA-Z0-9_]*)(?=\()\b</expression> -->
				<!-- <expression>\b^([a-zA-Z_][a-zA-Z0-9_]*)\:([a-zA-Z_][a-zA-Z0-9_]*)\b</expression> -->
			<!-- </scope> -->
			<!-- <scope name="parser3.identifier.function"> -->
				<!-- <expression>\b(?&lt;!\.)([a-zA-Z_][a-zA-Z0-9_]*)(?=\()\b</expression> -->
				<!-- <expression>\b^([a-zA-Z_][a-zA-Z0-9_]*)\b</expression> -->
			<!-- </scope> -->
			<!-- <scope name="parser3.identifier"> -->
				<!-- <expression>\b[a-zA-Z_][A-Za-z0-9_]*\b</expression> -->
			<!-- </scope> -->
		<!-- </collection> -->

		<!-- Blocks -->
		<collection name="blocks">
			<scope name="parser3.block.default">
				<symbol type="block">
					<context behavior="subtree" />
				</symbol>
				<starts-with>
					<expression>\{</expression>
					<capture number="0" name="parser3.block.bracket" />
				</starts-with>
				<ends-with>
					<expression>\}</expression>
					<capture number="0" name="parser3.block.bracket" />
				</ends-with>
				<subscopes>
					<include syntax="self" />
				</subscopes>
			</scope>
		<!-- 
			<scope name="parser3.block.curl-options">
				<symbol type="block">
					<context behavior="subtree" />
				</symbol>
				<starts-with>
					<expression>(\^curl\:options)(\[)</expression>
					<capture number="1" name="parser3.block.curl-options.keyword" />
					<capture number="2" name="parser3.bracket" />
				</starts-with>
				<ends-with>
					<expression>(?=\])</expression>
					<capture number="1" name="parser3.bracket" />
				</ends-with>
				<subscopes>
				</subscopes>
			</scope>
		 -->
			<scope name="parser3.block.sql">
				<starts-with>
					<expression>(sql)(\{)</expression>
					<capture number="1" name="parser3.block.sql.keyword" />
					<capture number="2" name="parser3.bracket" />
				</starts-with>
				<ends-with>
					<expression>(?=\})</expression>
					<capture number="1" name="parser3.bracket" />
				</ends-with>
<!--				<subscopes></subscopes> -->
			</scope>
			
			<scope name="parser3.block.taint.options">
				<starts-with>
					<expression>\^(taint|untaint|apply-taint)(\[)</expression>
					<capture number="1" name="parser3.block.taint.keyword" />
					<capture number="2" name="parser3.bracket" />
				</starts-with>
				<ends-with>
					<expression>(?=\])</expression>
					<capture number="1" name="parser3.bracket" />
				</ends-with>
				<subscopes>
					<expression>(.*)</expression>
					<capture number="1" name="parser3.keyword.property" />
				</subscopes>
			</scope>

			<scope name="parser3.block.try">
				<starts-with>
					<expression>(\^try)(\{)</expression>
					<capture number="1" name="parser3.block.try.keyword" />
					<capture number="2" name="parser3.bracket" />
				</starts-with>
				<ends-with>
					<expression>(?=\})</expression>
					<capture number="1" name="parser3.bracket" />
				</ends-with>
<!--				<subscopes></subscopes> -->
			</scope>
			
		</collection>

    	<!-- Syntax -->
		<collection name="syntax">
			<scope name="parser3.bracket">
				<expression>[\(\[\{\)\]\}]</expression>
			</scope>
			<scope name="parser3.operator">
				<expression>(\+|\-|\*|\*\*|/|%|\=|\=\=|!\=|\+\=|\-\=|\*\=|/\=|%\=|\*\*=|\&lt;|\&gt;|\&lt;\=|\&gt;=|!|&amp;&amp;|\|\|)</expression>
			</scope>
		</collection>
	</collections>

</syntax>
